Commands:
Command to use after rebasing from main in local branch and you get an error with FETCH-HEAD:
git push --force-with-lease origin YOUR-BRANCH-CHANGE-THIS

Command to use when refreshing branches from origin: git remote update origin --prune
![Alt Text](https://media.giphy.com/media/vFKqnCdLPNOKc/giphy.gif)

# Project P2: Hotel Room Allocation System

This document outlines the architecture and workflow of the P2 Hotel Room Allocation System. The system is a web application designed to simulate and evaluate different strategies for assigning hotel room bookings.

## 1. Overview

The application allows users to:
1.  **Generate a batch of synthetic hotel bookings** with varying stay durations, guest numbers, and preferences.
2.  **Simulate room allocation** over a specified number of days using one of three algorithms:
    *   **Least Difference (Best Fit):** Sorts bookings by duration, then assigns them to rooms trying to minimize wasted space (gaps before/after bookings) and then optimizes for guest preferences.
    *   **Stay Duration:** Sorts bookings by duration, assigns them sequentially, and then optimizes for guest preferences.
    *   **Random:** Assigns bookings to available rooms randomly without initial sorting by duration, and calculates preference scores directly.
3.  **Visualize the allocations** on a dynamic calendar interface (using FullCalendar).
4.  **View evaluation metrics** for each allocation run, including average preference scores, number of assigned/failed bookings, and room occupancy rates.
5.  **Reset the simulation state.**

## 2. Project Structure

The project is organized into server-side logic, client-side interface, and data files.

*   **`p2/`**: Root project directory.
    *   **`server.js`**: Sets up the Node.js HTTP server.
    *   **`router.js`**: Handles API request routing and orchestrates the core application logic.
    *   **`public/`**: Contains client-side static assets.
        *   `html/index.html`: The main HTML page for the user interface.
        *   `css/allocate.css`: Styles for the application.
        *   `js/allocation.js`: Client-side JavaScript for handling button clicks, making API calls to the server for allocation and booking generation, and updating the calendar/evaluation display.
        *   `js/calendar.js`: Initializes and configures the FullCalendar component to display rooms and bookings.
    *   **`src/`**: Contains server-side source code.
        *   `json/`:
            *   `bookings.json`: Stores the generated booking data.
            *   `rooms.json`: Stores the hotel room data (likely generated by `roomGenerator.js`).
        *   `scripts/`: Core algorithmic logic.
            *   `algorithm.js`: Implements the preference optimization logic used by "Least Difference" and "Stay Duration" strategies.
            *   `assignBookings.js`: Handles the initial assignment of bookings to rooms based on the selected strategy (Best Fit, Sort by Duration, Random).
            *   `availabilityMatrix.js`: Manages the data structure (`availabilityGrid`) that tracks room availability over time.
            *   `roomGenerator.js`: (Presumed) Generates the `rooms.json` file based on defined parameters.
        *   `utils/`: Utility functions and global variables.
            *   `getInfo.js`: Loads data from `bookings.json` and `rooms.json`.
            *   `globalVariables.js`: Defines global configuration (e.g., hotel structure, preference types) and dynamic state (e.g., current simulation day, evaluation metrics).
            *   `impartial.js`: Generates synthetic booking data with random attributes and preferences, and writes it to `bookings.json`.
            *   `preferences.js`: Generates specific preference details for bookings and rooms.
            *   `prefScores.js`: Calculates preference scores for a booking in a given room.
            *   `wastedSpaceScore.js`: Calculates metrics related to room occupancy and wasted space.
    *   **`tests/`**: Contains unit tests (e.g., `unit.test.js`).
    *   `package.json`: Project metadata and dependencies.
    *   `jest.config.mjs`: Jest test runner configuration.

## 3. Application Workflow

### 3.1. Server Initialization
1.  `server.js` starts an HTTP server (typically on `localhost:3000`).
2.  `router.js` is invoked by `server.js` to handle incoming requests. It also calls `startServer()`.
3.  `globalVariables.js` loads room information from `rooms.json` via `getInfo.js` when the application starts.

### 3.2. User Interaction & Frontend (Client-Side)
1.  The user opens `public/html/index.html` in their browser.
2.  `public/js/calendar.js` fetches room data from the `/rooms` API endpoint (served by `router.js`) and initializes the FullCalendar display, showing available rooms.
3.  The UI (`index.html`) provides controls:
    *   Input for "Number of days to allocate".
    *   Input for "Amount of bookings" to generate.
    *   Buttons: "Generate bookings", "Allocate least difference", "Allocate stay duration", "Allocate random", "Reset matrix", "Reset everything".
    *   An "Evaluation Summary" section to display metrics.

### 3.3. Generating Bookings
1.  User enters an amount and clicks "Generate bookings".
2.  `public/js/allocation.js` (`generateBatches` function) sends a `POST` request to `/generateBookings?amountOfBookings=<value>` on the server.
3.  `router.js` handles this request:
    *   Calls `storeBookings` from `src/utils/impartial.js`.
    *   `impartial.js` (`createBookingBatch`):
        *   Generates the specified number of booking objects with random check-in/out dates, guest numbers, and preferences (using `preferences.js`).
        *   Calls `extendGrid` (from `availabilityMatrix.js`) to ensure the `availabilityGrid` can accommodate the date range of the new bookings.
        *   Writes the generated bookings to `src/json/bookings.json`.
        *   Reloads bookings into memory via `loadBookings` (from `getInfo.js`).
    *   `router.js` sends a success response to the client.

### 3.4. Allocating Bookings
1.  User enters the number of days and clicks one of the allocation strategy buttons (e.g., "Allocate least difference").
2.  `public/js/allocation.js` (e.g., `allocateLeastDiff` function):
    *   Sends a `GET` request to the corresponding server endpoint (e.g., `/leastDiff?days=<value>`).
3.  `router.js` handles the allocation request (e.g., `/leastDiff`):
    *   Calls the `allocate(res, days, version)` function.
    *   The `allocate` function iterates for the specified number of `days`:
        *   **a. Initial Assignment (`matchBookingsToRooms` from `assignBookings.js`):**
            *   Loads current bookings and rooms.
            *   Filters bookings to get those "visible" for the `globalState.currentDay`.
            *   **Sorting (if not Random):** If "Least Difference" or "Stay Duration", sorts visible bookings by `stayDuration` (longest first).
            *   **Room Assignment:**
                *   **Best Fit (version 0):** Uses `bestFit` algorithm. For each booking, it finds an available room of the correct size that minimizes a weighted score of (1) proximity to previous bookings and (2) impact on future availability.
                *   **Sort by Duration (version 1) / Random (version 2):** Uses `assignResId`. For each booking, it finds the first available room of the correct size.
            *   Bookings that cannot be placed are added to `discardedBookings`.
            *   For the Random strategy, preference scores are calculated here using `calculatePrefScoreRandom` (from `prefScores.js`), and the main `availabilityGrid` is updated.
        *   **b. Preference Optimization (if not Random - `preferenceOptimization` from `algorithm.js`):**
            *   This step applies only to "Least Difference" and "Stay Duration" strategies.
            *   It takes the bookings assigned in the previous step (for the current day).
            *   It attempts to improve placements by swapping bookings between rooms to maximize guest preference scores.
            *   It calculates preference scores using `calculatePrefScore` (from `prefScores.js`).
            *   Bookings are prioritized for optimization (longer stays, then fewer preferences first).
            *   The main `availabilityGrid` is updated with these optimized placements.
        *   **c. Advance Day:** `globalState.currentDay` is incremented.
    *   After iterating through all days, `router.js` calculates evaluation metrics (average preference score, assigned/failed counts, wasted space scores using `wastedSpaceScore.js`) and stores them in `globalState`.
    *   `router.js` sends the array of allocated bookings (those starting on the simulated days) back to the client as a JSON response.
4.  `public/js/allocation.js` (in the `fetch` callback):
    *   Calls `appendToCalendar` to add the received bookings to the FullCalendar display with a color specific to the algorithm.
    *   Calls `updateEvaluationDisplay` which fetches data from the `/evaluation` endpoint (served by `router.js`) and updates the UI.

### 3.5. Resetting
1.  User clicks "Reset matrix" or "Reset everything".
2.  `public/js/allocation.js` (`resetMatrix` or `resetEverything`):
    *   "Reset everything" also clears events from the client-side calendar.
    *   Sends a `POST` request to `/reset` on the server.
3.  `router.js` handles `/reset`:
    *   Calls `clearMatrix()` (from `availabilityMatrix.js`) to set all entries in the server-side `availabilityGrid` to 0.
    *   Resets `startValue` (used in `allocate` to track simulation progress) and `globalState`.
    *   Sends a success response.

## 4. Core Data Structures & Logic

*   **`availabilityGrid` (`availabilityMatrix.js`)**: A central object where keys are room numbers and values are arrays representing daily availability. `0` means free, booking IDs (with 's'/'e' prefixes for start/end) mean occupied.
*   **Booking Object**: Contains `checkInDate`, `checkOutDate`, `guestsNumber`, `stayDuration`, `dayOfBooking`, `resourceIds` (assigned room number), `bookingId`, and a `preference` object.
*   **Room Object**: Contains `roomNumber`, `roomGuests` (capacity), and a `preference` object (e.g., bed type, floor).
*   **Preference Scoring (`prefScores.js`)**: Calculates a score (typically 0 to 1) based on how well a room's attributes match a booking's preferences.
*   **Global State (`globalVariables.js`)**: Tracks `currentDay` of the simulation and accumulates evaluation metrics.

## 5. Allocation Strategies Deep Dive

*   **Random:** Simplest approach. Bookings (for the current day) are assigned to the first available room that fits, without prior sorting. Preference scores are calculated post-assignment.
*   **Stay Duration:** Bookings are first sorted by duration (longest first). Then, they are assigned to the first available room that fits. After this initial assignment for the day, `preferenceOptimization` attempts to swap bookings among their assigned rooms to improve overall preference scores.
*   **Least Difference (Best Fit):** Bookings are sorted by duration. The `bestFit` algorithm then tries to place each booking in a room that not only fits but also minimizes gaps (empty days before this booking and after it, relative to other bookings). After this sophisticated initial assignment for the day, `preferenceOptimization` further refines placements based on preferences.

This system provides a robust framework for simulating and comparing different hotel room allocation strategies, with a clear separation of concerns between frontend display, backend API/orchestration, and core algorithmic logic.
